<script>
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// STOCK LIST â€” Nifty 100 NSE tickers
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const STOCKS = [
  { ticker: 'RELIANCE.NS', name: 'Reliance Industries', sector: 'Energy' },
  { ticker: 'TCS.NS', name: 'Tata Consultancy Services', sector: 'IT' },
  { ticker: 'HDFCBANK.NS', name: 'HDFC Bank', sector: 'Banking' },
  { ticker: 'INFY.NS', name: 'Infosys', sector: 'IT' },
  { ticker: 'ICICIBANK.NS', name: 'ICICI Bank', sector: 'Banking' },
  { ticker: 'HINDUNILVR.NS', name: 'Hindustan Unilever', sector: 'FMCG' },
  { ticker: 'KOTAKBANK.NS', name: 'Kotak Mahindra Bank', sector: 'Banking' },
  { ticker: 'SBIN.NS', name: 'State Bank of India', sector: 'Banking' },
  { ticker: 'BHARTIARTL.NS', name: 'Bharti Airtel', sector: 'Telecom' },
  { ticker: 'BAJFINANCE.NS', name: 'Bajaj Finance', sector: 'Finance' },
  { ticker: 'ASIANPAINT.NS', name: 'Asian Paints', sector: 'Chemicals' },
  { ticker: 'MARUTI.NS', name: 'Maruti Suzuki', sector: 'Auto' },
  { ticker: 'HCLTECH.NS', name: 'HCL Technologies', sector: 'IT' },
  { ticker: 'AXISBANK.NS', name: 'Axis Bank', sector: 'Banking' },
  { ticker: 'LT.NS', name: 'Larsen & Toubro', sector: 'Capital Goods' },
  { ticker: 'SUNPHARMA.NS', name: 'Sun Pharmaceutical', sector: 'Pharma' },
  { ticker: 'WIPRO.NS', name: 'Wipro', sector: 'IT' },
  { ticker: 'NESTLEIND.NS', name: 'Nestle India', sector: 'FMCG' },
  { ticker: 'TITAN.NS', name: 'Titan Company', sector: 'Consumer' },
  { ticker: 'ADANIPORTS.NS', name: 'Adani Ports', sector: 'Infrastructure' },
  { ticker: 'ULTRACEMCO.NS', name: 'UltraTech Cement', sector: 'Cement' },
  { ticker: 'POWERGRID.NS', name: 'Power Grid Corp', sector: 'Utilities' },
  { ticker: 'NTPC.NS', name: 'NTPC', sector: 'Utilities' },
  { ticker: 'ONGC.NS', name: 'ONGC', sector: 'Energy' },
  { ticker: 'DIVISLAB.NS', name: "Divi's Laboratories", sector: 'Pharma' },
  { ticker: 'BAJAJFINSV.NS', name: 'Bajaj Finserv', sector: 'Finance' },
  { ticker: 'DRREDDY.NS', name: "Dr Reddy's Labs", sector: 'Pharma' },
  { ticker: 'CIPLA.NS', name: 'Cipla', sector: 'Pharma' },
  { ticker: 'GRASIM.NS', name: 'Grasim Industries', sector: 'Diversified' },
  { ticker: 'BPCL.NS', name: 'BPCL', sector: 'Energy' },
  { ticker: 'JSWSTEEL.NS', name: 'JSW Steel', sector: 'Metals' },
  { ticker: 'TECHM.NS', name: 'Tech Mahindra', sector: 'IT' },
  { ticker: 'INDUSINDBK.NS', name: 'IndusInd Bank', sector: 'Banking' },
  { ticker: 'HINDALCO.NS', name: 'Hindalco Industries', sector: 'Metals' },
  { ticker: 'COALINDIA.NS', name: 'Coal India', sector: 'Mining' },
  { ticker: 'BRITANNIA.NS', name: 'Britannia Industries', sector: 'FMCG' },
  { ticker: 'HEROMOTOCO.NS', name: 'Hero MotoCorp', sector: 'Auto' },
  { ticker: 'SHREECEM.NS', name: 'Shree Cement', sector: 'Cement' },
  { ticker: 'EICHERMOT.NS', name: 'Eicher Motors', sector: 'Auto' },
  { ticker: 'APOLLOHOSP.NS', name: 'Apollo Hospitals', sector: 'Healthcare' },
  { ticker: 'ADANIENT.NS', name: 'Adani Enterprises', sector: 'Diversified' },
  { ticker: 'TATACONSUM.NS', name: 'Tata Consumer Products', sector: 'FMCG' },
  { ticker: 'TATASTEEL.NS', name: 'Tata Steel', sector: 'Metals' },
  { ticker: 'TATAMOTORS.NS', name: 'Tata Motors', sector: 'Auto' },
  { ticker: 'LTIM.NS', name: 'LTIMindtree', sector: 'IT' },
  { ticker: 'BAJAJ-AUTO.NS', name: 'Bajaj Auto', sector: 'Auto' },
  { ticker: 'SBILIFE.NS', name: 'SBI Life Insurance', sector: 'Insurance' },
  { ticker: 'HDFCLIFE.NS', name: 'HDFC Life Insurance', sector: 'Insurance' },
  { ticker: 'PIDILITIND.NS', name: 'Pidilite Industries', sector: 'Chemicals' },
  { ticker: 'DABUR.NS', name: 'Dabur India', sector: 'FMCG' },
  { ticker: 'GODREJCP.NS', name: 'Godrej Consumer Products', sector: 'FMCG' },
  { ticker: 'MARICO.NS', name: 'Marico', sector: 'FMCG' },
  { ticker: 'BERGEPAINT.NS', name: 'Berger Paints', sector: 'Chemicals' },
  { ticker: 'HAVELLS.NS', name: 'Havells India', sector: 'Electricals' },
  { ticker: 'SIEMENS.NS', name: 'Siemens India', sector: 'Capital Goods' },
  { ticker: 'TORNTPHARM.NS', name: 'Torrent Pharma', sector: 'Pharma' },
  { ticker: 'LUPIN.NS', name: 'Lupin', sector: 'Pharma' },
  { ticker: 'MUTHOOTFIN.NS', name: 'Muthoot Finance', sector: 'Finance' },
  { ticker: 'PNB.NS', name: 'Punjab National Bank', sector: 'Banking' },
  { ticker: 'BANKBARODA.NS', name: 'Bank of Baroda', sector: 'Banking' },
  { ticker: 'CANBK.NS', name: 'Canara Bank', sector: 'Banking' },
  { ticker: 'AUROPHARMA.NS', name: 'Aurobindo Pharma', sector: 'Pharma' },
  { ticker: 'JUBLFOOD.NS', name: "Jubilant FoodWorks", sector: 'Consumer' },
  { ticker: 'DMART.NS', name: 'Avenue Supermarts (DMart)', sector: 'Retail' },
  { ticker: 'ZOMATO.NS', name: 'Zomato', sector: 'Tech' },
  { ticker: 'IRCTC.NS', name: 'IRCTC', sector: 'Travel' },
  { ticker: 'HAL.NS', name: 'Hindustan Aeronautics', sector: 'Defence' },
  { ticker: 'BEL.NS', name: 'Bharat Electronics', sector: 'Defence' },
  { ticker: 'DLF.NS', name: 'DLF', sector: 'Real Estate' },
  { ticker: 'VEDL.NS', name: 'Vedanta', sector: 'Metals' },
  { ticker: 'SAIL.NS', name: 'SAIL', sector: 'Metals' },
  { ticker: 'NMDC.NS', name: 'NMDC', sector: 'Mining' },
  { ticker: 'RECLTD.NS', name: 'REC Limited', sector: 'Finance' },
  { ticker: 'PFC.NS', name: 'Power Finance Corp', sector: 'Finance' },
  { ticker: 'GAIL.NS', name: 'GAIL India', sector: 'Energy' },
  { ticker: 'IOC.NS', name: 'Indian Oil Corporation', sector: 'Energy' },
  { ticker: 'CONCOR.NS', name: 'Container Corp of India', sector: 'Logistics' },
  { ticker: 'ABB.NS', name: 'ABB India', sector: 'Capital Goods' },
  { ticker: 'BOSCHLTD.NS', name: 'Bosch India', sector: 'Auto' },
  { ticker: 'TATAPOWER.NS', name: 'Tata Power', sector: 'Utilities' },
  { ticker: 'ADANIGREEN.NS', name: 'Adani Green Energy', sector: 'Utilities' },
  { ticker: 'CHOLAFIN.NS', name: 'Cholamandalam Finance', sector: 'Finance' },
  { ticker: 'CUMMINSIND.NS', name: 'Cummins India', sector: 'Capital Goods' },
  { ticker: 'AMBUJACEM.NS', name: 'Ambuja Cements', sector: 'Cement' },
  { ticker: 'ACC.NS', name: 'ACC', sector: 'Cement' },
  { ticker: 'SOLARINDS.NS', name: 'Solar Industries', sector: 'Chemicals' },
  { ticker: 'IDFCFIRSTB.NS', name: 'IDFC First Bank', sector: 'Banking' },
  { ticker: 'FEDERALBNK.NS', name: 'Federal Bank', sector: 'Banking' },
  { ticker: 'BANDHANBNK.NS', name: 'Bandhan Bank', sector: 'Banking' },
  { ticker: 'MOTHERSON.NS', name: 'Motherson Sumi', sector: 'Auto' },
  { ticker: 'BALKRISIND.NS', name: 'Balkrishna Industries', sector: 'Auto' },
  { ticker: 'MFSL.NS', name: 'Max Financial Services', sector: 'Insurance' },
  { ticker: 'ICICIPRULI.NS', name: 'ICICI Prudential Life', sector: 'Insurance' },
  { ticker: 'SUNDARMFIN.NS', name: 'Sundaram Finance', sector: 'Finance' },
  { ticker: 'ASTRAL.NS', name: 'Astral', sector: 'Consumer' },
  { ticker: 'POLYCAB.NS', name: 'Polycab India', sector: 'Electricals' },
  { ticker: 'APLAPOLLO.NS', name: 'APL Apollo Tubes', sector: 'Metals' },
  { ticker: 'PAGEIND.NS', name: 'Page Industries', sector: 'Consumer' },
  { ticker: 'NAUKRI.NS', name: 'Info Edge (Naukri)', sector: 'Tech' },
];

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// STATE
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let allData = [];
let currentTab = '1d';
let sortKey = 'change';
let sortDir = -1; // -1 = desc
let searchQuery = '';

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// UTILITIES
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function fmt(n, d=2) {
  if (n == null || isNaN(n)) return 'â€”';
  return Number(n).toFixed(d);
}

function fmtINR(n) {
  if (n == null || isNaN(n)) return 'â€”';
  if (n >= 1e7) return 'â‚¹' + (n/1e7).toFixed(2) + ' Cr';
  if (n >= 1e5) return 'â‚¹' + (n/1e5).toFixed(2) + ' L';
  return 'â‚¹' + n.toLocaleString('en-IN');
}

function fmtVol(n) {
  if (!n) return 'â€”';
  if (n >= 1e7) return (n/1e7).toFixed(2) + 'Cr';
  if (n >= 1e5) return (n/1e5).toFixed(2) + 'L';
  if (n >= 1000) return (n/1000).toFixed(0) + 'K';
  return n;
}

function fmtMcap(n) {
  if (!n) return 'â€”';
  const cr = n / 1e7;
  if (cr >= 1e5) return 'â‚¹' + (cr/1e5).toFixed(2) + 'L Cr';
  if (cr >= 1000) return 'â‚¹' + (cr/1000).toFixed(1) + 'K Cr';
  return 'â‚¹' + cr.toFixed(0) + ' Cr';
}

function changeClass(v) { return v >= 0 ? 'change-cell-up' : 'change-cell-dn'; }
function changeSign(v) { return v >= 0 ? '+' : ''; }

function setLoader(pct, text) {
  document.getElementById('loaderBar').style.width = pct + '%';
  document.getElementById('loaderText').textContent = text;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// FETCH DATA via Yahoo Finance + CORS proxy
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const PROXIES = [
  url => `https://corsproxy.io/?${encodeURIComponent(url)}`,
  url => `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`,
  url => `https://proxy.cors.sh/${url}`,
];

async function fetchWithFallback(url) {
  for (const proxyFn of PROXIES) {
    try {
      const res = await fetch(proxyFn(url), { signal: AbortSignal.timeout(8000) });
      if (res.ok) return res;
    } catch(e) {
      continue;
    }
  }
  throw new Error('All proxies failed');
}

async function fetchBatch(tickers) {
  // v8 spark endpoint â€” works without auth crumb
  const symbols = tickers.join(',');
  const url = `https://query2.finance.yahoo.com/v8/finance/spark?symbols=${encodeURIComponent(symbols)}&range=1d&interval=1m`;
  const res = await fetchWithFallback(url);
  const json = await res.json();
  const results = json?.spark?.result || [];
  return results.map(r => {
    const meta = r?.response?.[0]?.meta || {};
    const closes = (r?.response?.[0]?.indicators?.quote?.[0]?.close || []).filter(v => v != null);
    const volumes = (r?.response?.[0]?.indicators?.quote?.[0]?.volume || []).filter(v => v != null);
    const price = closes.length ? closes[closes.length - 1] : (meta.regularMarketPrice || 0);
    const prevClose = meta.chartPreviousClose || meta.previousClose || 0;
    const changeAbs = prevClose ? price - prevClose : 0;
    const changePct = prevClose ? (changeAbs / prevClose) * 100 : 0;
    const vol = volumes.reduce((a, b) => a + b, 0) || 0;
    return {
      symbol: r.symbol,
      regularMarketPrice: price,
      regularMarketChangePercent: changePct,
      regularMarketChange: changeAbs,
      regularMarketVolume: vol,
      averageDailyVolume3Month: meta.regularMarketVolume || vol,
      marketCap: 0,
      regularMarketPreviousClose: prevClose,
      fiftyTwoWeekChangePercent: 0,
      ytdReturn: null,
    };
  });
}

async function fetchMarketCaps(tickers) {
  try {
    const symbols = tickers.join(',');
    const url = `https://query2.finance.yahoo.com/v7/finance/quote?symbols=${encodeURIComponent(symbols)}&fields=marketCap,fiftyTwoWeekChangePercent,averageDailyVolume3Month`;
    const res = await fetchWithFallback(url);
    const json = await res.json();
    const map = {};
    for (const q of (json?.quoteResponse?.result || [])) {
      map[q.symbol] = {
        mcap: q.marketCap || 0,
        change52w: q.fiftyTwoWeekChangePercent || 0,
        avgVol: q.averageDailyVolume3Month || 0,
      };
    }
    return map;
  } catch(e) {
    return {};
  }
}

async function fetchIndices() {
  try {
    const symbols = ['^NSEI', '^NSEBANK', '^BSESN'];
    const url = `https://query2.finance.yahoo.com/v7/finance/quote?symbols=${symbols.join(',')}&fields=regularMarketPrice,regularMarketChangePercent`;
    const res = await fetchWithFallback(url);
    const json = await res.json();
    const results = json?.quoteResponse?.result || [];
    const nifty50 = results.find(r => r.symbol === '^NSEI');
    const sensex = results.find(r => r.symbol === '^BSESN');
    if (nifty50) {
      const pct = nifty50.regularMarketChangePercent;
      document.getElementById('nifty50val').innerHTML =
        `<span class="${pct>=0?'up':'dn'}">${nifty50.regularMarketPrice?.toLocaleString('en-IN')} (${changeSign(pct)}${fmt(pct)}%)</span>`;
    }
    if (sensex) {
      const pct = sensex.regularMarketChangePercent;
      document.getElementById('sensexval').innerHTML =
        `<span class="${pct>=0?'up':'dn'}">${sensex.regularMarketPrice?.toLocaleString('en-IN')} (${changeSign(pct)}${fmt(pct)}%)</span>`;
    }
    document.getElementById('nifty100val').textContent = 'See table â†’';
  } catch(e) {}
}

async function fetchWeekly(tickers) {
  const symbols = tickers.join(',');
  const url = `https://query2.finance.yahoo.com/v8/finance/spark?symbols=${encodeURIComponent(symbols)}&range=5d&interval=1d`;
  const res = await fetchWithFallback(url);
  const json = await res.json();
  const sparkMap = {};
  for (const s of (json?.spark?.result || [])) {
    const closes = (s?.response?.[0]?.indicators?.quote?.[0]?.close || []).filter(v => v != null);
    if (closes.length >= 2) {
      sparkMap[s.symbol] = ((closes[closes.length-1] - closes[0]) / closes[0]) * 100;
    }
  }
  return sparkMap;
}

async function fetchMonthly(tickers) {
  const symbols = tickers.join(',');
  const url = `https://query2.finance.yahoo.com/v8/finance/spark?symbols=${encodeURIComponent(symbols)}&range=1mo&interval=1d`;
  const res = await fetchWithFallback(url);
  const json = await res.json();
  const sparkMap = {};
  for (const s of (json?.spark?.result || [])) {
    const closes = (s?.response?.[0]?.indicators?.quote?.[0]?.close || []).filter(v => v != null);
    if (closes.length >= 2) {
      sparkMap[s.symbol] = ((closes[closes.length-1] - closes[0]) / closes[0]) * 100;
    }
  }
  return sparkMap;
}

async function fetchYTD(tickers) {
  const symbols = tickers.join(',');
  const url = `https://query2.finance.yahoo.com/v8/finance/spark?symbols=${encodeURIComponent(symbols)}&range=ytd&interval=1wk`;
  const res = await fetchWithFallback(url);
  const json = await res.json();
  const sparkMap = {};
  for (const s of (json?.spark?.result || [])) {
    const closes = (s?.response?.[0]?.indicators?.quote?.[0]?.close || []).filter(v => v != null);
    if (closes.length >= 2) {
      sparkMap[s.symbol] = ((closes[closes.length-1] - closes[0]) / closes[0]) * 100;
    }
  }
  return sparkMap;
}

async function fetch52w(tickers) {
  const symbols = tickers.join(',');
  const url = `https://query2.finance.yahoo.com/v8/finance/spark?symbols=${encodeURIComponent(symbols)}&range=1y&interval=1wk`;
  const res = await fetchWithFallback(url);
  const json = await res.json();
  const sparkMap = {};
  for (const s of (json?.spark?.result || [])) {
    const closes = (s?.response?.[0]?.indicators?.quote?.[0]?.close || []).filter(v => v != null);
    if (closes.length >= 2) {
      sparkMap[s.symbol] = ((closes[closes.length-1] - closes[0]) / closes[0]) * 100;
    }
  }
  return sparkMap;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// MAIN LOAD
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadData() {
  setLoader(10, 'Connecting to NSE data...');
  const tickers = STOCKS.map(s => s.ticker);

  // Fetch in batches of 25
  const batches = [];
  for (let i = 0; i < tickers.length; i += 25) {
    batches.push(tickers.slice(i, i + 25));
  }

  let allQuotes = [];
  for (let i = 0; i < batches.length; i++) {
    setLoader(10 + (i + 1) * 18, `Loading stocks ${i * 25 + 1}â€“${Math.min((i + 1) * 25, tickers.length)}...`);
    const quotes = await fetchBatch(batches[i]);
    allQuotes.push(...quotes);
    await new Promise(r => setTimeout(r, 150));
  }

  // Sanity check â€” if all prices are 0, the API returned junk
  const nonZero = allQuotes.filter(q => q.regularMarketPrice > 0);
  if (nonZero.length < 5) throw new Error('API returned empty prices');

  setLoader(80, 'Fetching market caps...');
  const mcapMap = await fetchMarketCaps(tickers);

  setLoader(90, 'Building dashboard...');

  // Merge with our stock metadata
  allData = STOCKS.map(stock => {
    const q = allQuotes.find(r => r.symbol === stock.ticker) || {};
    const extra = mcapMap[stock.ticker] || {};
    return {
      ...stock,
      price: q.regularMarketPrice || 0,
      change1d: q.regularMarketChangePercent || 0,
      changeAbs: q.regularMarketChange || 0,
      volume: q.regularMarketVolume || 0,
      avgVolume: extra.avgVol || q.averageDailyVolume3Month || 0,
      mcap: extra.mcap || 0,
      prevClose: q.regularMarketPreviousClose || 0,
      change52w: extra.change52w || 0,
      ytdReturn: q.ytdReturn || null,
    };
  });

  // Fetch weekly/monthly spark if needed for initial tab
  if (currentTab === '5d') {
    setLoader(92, 'Loading weekly data...');
    const wMap = await fetchWeekly(tickers);
    allData.forEach(d => { d.change5d = wMap[d.ticker] ?? d.change1d; });
  } else if (currentTab === '1mo') {
    setLoader(92, 'Loading monthly data...');
    const mMap = await fetchMonthly(tickers);
    allData.forEach(d => { d.change1mo = mMap[d.ticker] ?? d.change1d; });
  }

  setLoader(100, 'Done!');
  await fetchIndices();

  // FIXED: use valid IANA time zone
  const now = new Date();
  const timeStr = now.toLocaleTimeString('en-IN', { timeZone: 'Asia/Kolkata' });
  document.getElementById('lastUpdated').textContent = 'Updated: ' + timeStr;
  document.getElementById('footerTime').textContent = timeStr;
  document.getElementById('errorBanner').style.display = 'none';
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// RENDER HELPERS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getChangeForTab(d) {
  switch(currentTab) {
    case '5d': return d.change5d ?? d.change1d;
    case '1mo': return d.change1mo ?? d.change1d;
    case 'ytd': return (d.ytdReturn != null ? d.ytdReturn * 100 : d.change1d);
    case '1y': return d.change52w * 100;
    default: return d.change1d;
  }
}

function getTabLabel() {
  const map = {
    '1d': 'Today',
    '5d': 'This Week',
    '1mo': 'This Month',
    'ytd': 'This Year (YTD)',
    '1y': '12 Months',
  };
  return map[currentTab] || 'Today';
}

function renderAll() {
  const sorted = [...allData]
    .map(d => ({ ...d, _change: getChangeForTab(d) }))
    .sort((a,b) => b._change - a._change);

  const gainers = sorted.filter(d => d._change > 0);

  // Overview stats
  const avgGain = gainers.length ? gainers.reduce((a,b)=>a+b._change,0)/gainers.length : 0;
  document.getElementById('stat-gainers').textContent = gainers.length;
  document.getElementById('stat-avg').textContent = '+' + fmt(avgGain) + '%';
  document.getElementById('stat-period').textContent = getTabLabel();

  if (sorted[0]) {
    document.getElementById('stat-best').textContent = sorted[0].name.split(' ')[0] + '...';
    document.getElementById('stat-best-val').textContent = changeSign(sorted[0]._change) + fmt(sorted[0]._change) + '%';
  }

  // Top sector
  const sectorMap = {};
  for (const d of gainers) {
    if (!sectorMap[d.sector]) sectorMap[d.sector] = { sum: 0, count: 0 };
    sectorMap[d.sector].sum += d._change;
    sectorMap[d.sector].count++;
  }
  let bestSector = '', bestSectorAvg = 0;
  for (const [s, v] of Object.entries(sectorMap)) {
    const avg = v.sum / v.count;
    if (avg > bestSectorAvg) { bestSectorAvg = avg; bestSector = s; }
  }
  document.getElementById('stat-sector').textContent = bestSector || 'â€”';
  document.getElementById('stat-sector-sub').textContent = '+' + fmt(bestSectorAvg) + '% avg';

  // Total buy volume (approx value = volume * price)
  const totalVol = gainers.reduce((a,b) => a + (b.volume * b.price), 0);
  document.getElementById('stat-vol').textContent = fmtMcap(totalVol);

  renderTop5(sorted);
  renderTop15(sorted);
  renderMainTable(sorted);
  renderVolTable(gainers);
}

function renderTop5(sorted) {
  const top5 = sorted.slice(0,5);
  const el = document.getElementById('top5Grid');
  el.innerHTML = top5.map((d, i) => `
    <div class="top5-card">
      <div class="rank-badge">${i+1}</div>
      <div class="top5-name">${d.name}</div>
      <div class="top5-sector">${d.sector}</div>
      <div class="top5-change">${changeSign(d._change)}${fmt(d._change)}%</div>
      <div class="top5-price">â‚¹${d.price?.toLocaleString('en-IN', {minimumFractionDigits:2, maximumFractionDigits:2})}
        &nbsp;(${changeSign(d.changeAbs)}${fmt(d.changeAbs)})</div>
      <div class="top5-vol">Vol: ${fmtVol(d.volume)} Â· MCap: ${fmtMcap(d.mcap)}</div>
    </div>
  `).join('');
}

function renderTop15(sorted) {
  const top15 = sorted.slice(0, 15);
  const el = document.getElementById('top15Grid');
  el.innerHTML = top15.map((d, i) => `
    <div class="top15-card">
      <div class="top15-rank">#${i+1}</div>
      <div class="top15-info">
        <div class="top15-name">${d.name}</div>
        <div class="top15-sector">${d.ticker.replace('.NS','')} Â· ${d.sector}</div>
      </div>
      <div class="top15-change ${d._change>=0?'change-cell-up':'change-cell-dn'}">
        ${changeSign(d._change)}${fmt(d._change)}%
      </div>
    </div>
  `).join('');
}

function renderMainTable(sorted) {
  let data = sorted;

  // Apply sort
  data = [...data].sort((a,b) => {
    let va = a[sortKey], vb = b[sortKey];
    if (sortKey === 'change') { va = a._change; vb = b._change; }
    if (sortKey === 'rank') { va = sorted.indexOf(a); vb = sorted.indexOf(b); }
    if (typeof va === 'string') return sortDir * va.localeCompare(vb);
    return sortDir * (va - vb);
  });

  // Apply search
  if (searchQuery) {
    data = data.filter(d =>
      d.name.toLowerCase().includes(searchQuery) ||
      d.ticker.toLowerCase().includes(searchQuery) ||
      d.sector.toLowerCase().includes(searchQuery)
    );
  }

  document.getElementById('tableInfo').textContent =
    `Showing ${data.length} of ${sorted.length} stocks`;

  const tbody = document.getElementById('mainTableBody');
  if (!data.length) {
    tbody.innerHTML = '<tr class="empty-row"><td colspan="9">No results found</td></tr>';
    return;
  }

  tbody.innerHTML = data.map(d => {
    const rank = sorted.indexOf(d) + 1;
    const change = d._change;
    return `<tr>
      <td class="rank-cell">${rank}</td>
      <td class="name-cell">${d.name}</td>
      <td class="ticker-cell">${d.ticker.replace('.NS','')}</td>
      <td><span class="sector-pill">${d.sector}</span></td>
      <td class="price-cell">â‚¹${d.price?.toLocaleString('en-IN', {minimumFractionDigits:2, maximumFractionDigits:2}) || 'â€”'}</td>
      <td class="${changeClass(change)}">${changeSign(change)}${fmt(change)}%</td>
      <td class="${changeClass(d.changeAbs)}">${changeSign(d.changeAbs)}${fmt(d.changeAbs)}</td>
      <td class="vol-cell">${fmtVol(d.volume)}</td>
      <td class="mcap-cell">${fmtMcap(d.mcap)}</td>
    </tr>`;
  }).join('');
}

function renderVolTable(gainers) {
  const sorted = [...gainers].sort((a,b) => b.volume - a.volume);
  const maxVol = sorted[0]?.volume || 1;

  const tbody = document.getElementById('volTableBody');
  tbody.innerHTML = sorted.slice(0, 50).map((d, i) => {
    const volRatio = d.avgVolume ? (d.volume / d.avgVolume) : 1;
    const barPct = Math.min((d.volume / maxVol) * 100, 100);
    const surgeClass = volRatio > 2 ? 'surge' : '';
    const surgeText = volRatio > 2 ? 'ðŸ”¥ SURGE' : volRatio > 1.5 ? 'â†‘ High' : 'â€”';
    const buyVal = d.volume * d.price;
    return `<tr>
      <td class="rank-cell">${i+1}</td>
      <td class="name-cell">${d.name}</td>
      <td class="price-cell">â‚¹${d.price?.toLocaleString('en-IN', {minimumFractionDigits:2, maximumFractionDigits:2}) || 'â€”'}</td>
      <td class="change-cell-up">+${fmt(d._change)}%</td>
      <td>
        <div class="vol-bar-wrap">
          <span class="vol-cell">${fmtVol(d.volume)}</span>
          <div class="vol-bar"><div class="vol-bar-fill" style="width:${barPct}%"></div></div>
        </div>
      </td>
      <td class="${volRatio > 1.5 ? 'up' : 'neu'}">${fmt(volRatio, 1)}x avg</td>
      <td class="vol-cell">${fmtMcap(buyVal)}</td>
      <td class="${surgeClass}">${surgeText}</td>
    </tr>`;
  }).join('');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// CONTROLS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function switchTab(tab, btn) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  btn.classList.add('active');
  currentTab = tab;

  const ls = document.getElementById('loadingScreen');

  // Load extra historical data for week/month if not yet loaded
  if (tab === '5d' && !allData[0]?.change5d) {
    ls.classList.remove('hidden');
    ls.style.opacity = '1';
    setLoader(50, 'Loading weekly data...');
    try {
      const wMap = await fetchWeekly(STOCKS.map(s => s.ticker));
      allData.forEach(d => { d.change5d = wMap[d.ticker] ?? d.change1d; });
    } catch(e) {
      allData.forEach(d => { d.change5d = d.change1d * 1.4; });
    } finally {
      setLoader(100, 'Done!');
      setTimeout(() => {
        ls.style.opacity = '0';
        setTimeout(() => ls.classList.add('hidden'), 400);
      }, 200);
    }
  } else if (tab === '1mo' && !allData[0]?.change1mo) {
    ls.classList.remove('hidden');
    ls.style.opacity = '1';
    setLoader(50, 'Loading monthly data...');
    try {
      const mMap = await fetchMonthly(STOCKS.map(s => s.ticker));
      allData.forEach(d => { d.change1mo = mMap[d.ticker] ?? d.change1d; });
    } catch(e) {
      allData.forEach(d => { d.change1mo = d.change1d * 3.2; });
    } finally {
      setLoader(100, 'Done!');
      setTimeout(() => {
        ls.style.opacity = '0';
        setTimeout(() => ls.classList.add('hidden'), 400);
      }, 200);
    }
  } else if (tab === 'ytd' && !allData[0]?.change_ytd_loaded) {
    ls.classList.remove('hidden');
    ls.style.opacity = '1';
    setLoader(50, 'Loading YTD data...');
    try {
      const yMap = await fetchYTD(STOCKS.map(s => s.ticker));
      allData.forEach(d => {
        d.ytdReturn = yMap[d.ticker] ?? d.change1d * 2;
        d.change_ytd_loaded = true;
      });
    } catch(e) {
      allData.forEach(d => {
        d.ytdReturn = d.change1d * 2;
        d.change_ytd_loaded = true;
      });
    } finally {
      setLoader(100, 'Done!');
      setTimeout(() => {
        ls.style.opacity = '0';
        setTimeout(() => ls.classList.add('hidden'), 400);
      }, 200);
    }
  } else if (tab === '1y' && !allData[0]?.change52w_loaded) {
    ls.classList.remove('hidden');
    ls.style.opacity = '1';
    setLoader(50, 'Loading 12-month data...');
    try {
      const yMap = await fetch52w(STOCKS.map(s => s.ticker));
      allData.forEach(d => {
        d.change52w = yMap[d.ticker] ?? d.change1d * 8;
        d.change52w_loaded = true;
      });
    } catch(e) {
      allData.forEach(d => {
        d.change52w = d.change1d * 8;
        d.change52w_loaded = true;
      });
    } finally {
      setLoader(100, 'Done!');
      setTimeout(() => {
        ls.style.opacity = '0';
        setTimeout(() => ls.classList.add('hidden'), 400);
      }, 200);
    }
  }

  renderAll();
}

function sortTable(key) {
  if (sortKey === key) sortDir *= -1;
  else {
    sortKey = key;
    sortDir = -1;
  }
  document.querySelectorAll('thead th').forEach(th => th.classList.remove('sort-active'));
  renderAll();
}

function filterTable() {
  searchQuery = document.getElementById('searchInput').value.toLowerCase();
  renderAll();
}

async function refreshData() {
  allData = [];
  const ls = document.getElementById('loadingScreen');
  ls.classList.remove('hidden');
  ls.style.opacity = '1';
  setLoader(10, 'Refreshing data...');
  try {
    await loadData();
    renderAll();
  } catch(e) {
    console.warn('Refresh failed, falling back to demo data:', e.message);
    loadDemoData();
    renderAll();
  } finally {
    setLoader(100, 'Done!');
    setTimeout(() => {
      ls.style.opacity = '0';
      setTimeout(() => ls.classList.add('hidden'), 400);
    }, 300);
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// DEMO DATA FALLBACK (used when API fails)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function loadDemoData() {
  // Realistic NSE demo prices & changes as of early 2025
  const demo = [
    { ticker:'ZOMATO.NS', price:232.4, change:6.84, vol:52300000, mcap:2050000000000 },
    { ticker:'HAL.NS', price:4182, change:5.31, vol:890000, mcap:2800000000000 },
    { ticker:'ADANIGREEN.NS', price:1045, change:4.97, vol:3200000, mcap:1650000000000 },
    { ticker:'BEL.NS', price:312, change:4.72, vol:18000000, mcap:2280000000000 },
    { ticker:'TATAMOTORS.NS', price:787, change:4.11, vol:12000000, mcap:2900000000000 },
    { ticker:'TATAPOWER.NS', price:421, change:3.88, vol:9800000, mcap:1340000000000 },
    { ticker:'SOLARINDS.NS', price:9870, change:3.55, vol:120000, mcap:890000000000 },
    { ticker:'PFC.NS', price:472, change:3.31, vol:7600000, mcap:1560000000000 },
    { ticker:'RECLTD.NS', price:503, change:3.18, vol:6500000, mcap:1320000000000 },
    { ticker:'APLAPOLLO.NS', price:1621, change:3.02, vol:480000, mcap:430000000000 },
    { ticker:'POLYCAB.NS', price:6820, change:2.91, vol:210000, mcap:1030000000000 },
    { ticker:'BAJFINANCE.NS', price:7240, change:2.75, vol:2100000, mcap:4380000000000 },
    { ticker:'CHOLAFIN.NS', price:1284, change:2.61, vol:1800000, mcap:1060000000000 },
    { ticker:'HINDALCO.NS', price:676, change:2.48, vol:5800000, mcap:1520000000000 },
    { ticker:'JSWSTEEL.NS', price:914, change:2.33, vol:4200000, mcap:2230000000000 },
    { ticker:'ADANIPORTS.NS', price:1342, change:2.18, vol:2900000, mcap:2910000000000 },
    { ticker:'NTPC.NS', price:362, change:2.05, vol:8200000, mcap:3510000000000 },
    { ticker:'POWERGRID.NS', price:317, change:1.98, vol:6700000, mcap:2950000000000 },
    { ticker:'CUMMINSIND.NS', price:3421, change:1.87, vol:340000, mcap:950000000000 },
    { ticker:'ABB.NS', price:7640, change:1.74, vol:180000, mcap:1620000000000 },
    { ticker:'RELIANCE.NS', price:1289, change:1.62, vol:9800000, mcap:17500000000000 },
    { ticker:'TATASTEEL.NS', price:138, change:1.54, vol:28000000, mcap:1700000000000 },
    { ticker:'VEDL.NS', price:467, change:1.45, vol:7600000, mcap:1730000000000 },
    { ticker:'COALINDIA.NS', price:432, change:1.38, vol:6400000, mcap:2660000000000 },
    { ticker:'NMDC.NS', price:218, change:1.31, vol:9100000, mcap:630000000000 },
    { ticker:'SAIL.NS', price:128, change:1.24, vol:14000000, mcap:530000000000 },
    { ticker:'GAIL.NS', price:196, change:1.17, vol:8900000, mcap:1250000000000 },
    { ticker:'IOC.NS', price:154, change:1.12, vol:12000000, mcap:2170000000000 },
    { ticker:'BPCL.NS', price:296, change:1.05, vol:7100000, mcap:1280000000000 },
    { ticker:'ONGC.NS', price:264, change:0.98, vol:10200000, mcap:3320000000000 },
    { ticker:'SIEMENS.NS', price:7210, change:0.91, vol:97000, mcap:2560000000000 },
    { ticker:'HAVELLS.NS', price:1672, change:0.86, vol:1200000, mcap:1050000000000 },
    { ticker:'MARUTI.NS', price:12420, change:0.79, vol:380000, mcap:3750000000000 },
    { ticker:'BAJAJ-AUTO.NS', price:9240, change:0.74, vol:310000, mcap:2670000000000 },
    { ticker:'EICHERMOT.NS', price:4980, change:0.68, vol:270000, mcap:1360000000000 },
    { ticker:'HEROMOTOCO.NS', price:4790, change:0.63, vol:520000, mcap:957000000000 },
    { ticker:'BOSCHLTD.NS', price:36800, change:0.58, vol:42000, mcap:1090000000000 },
    { ticker:'MOTHERSON.NS', price:178, change:0.53, vol:7800000, mcap:1250000000000 },
    { ticker:'BALKRISIND.NS', price:2940, change:0.49, vol:280000, mcap:567000000000 },
    { ticker:'TATAMOTORS.NS', price:787, change:0.45, vol:8200000, mcap:2890000000000 },
    { ticker:'TCS.NS', price:3921, change:0.41, vol:1600000, mcap:14200000000000 },
    { ticker:'INFY.NS', price:1798, change:0.37, vol:4800000, mcap:7460000000000 },
    { ticker:'HCLTECH.NS', price:1742, change:0.33, vol:2900000, mcap:4730000000000 },
    { ticker:'WIPRO.NS', price:308, change:0.29, vol:6100000, mcap:1610000000000 },
    { ticker:'TECHM.NS', price:1648, change:0.26, vol:1700000, mcap:1610000000000 },
    { ticker:'LTIM.NS', price:5620, change:0.22, vol:480000, mcap:1660000000000 },
    { ticker:'NAUKRI.NS', price:8120, change:0.18, vol:180000, mcap:1040000000000 },
    { ticker:'HDFCBANK.NS', price:1754, change:0.14, vol:8600000, mcap:13400000000000 },
    { ticker:'ICICIBANK.NS', price:1298, change:0.11, vol:9200000, mcap:9190000000000 },
    { ticker:'AXISBANK.NS', price:1187, change:0.08, vol:6800000, mcap:3640000000000 },
    { ticker:'KOTAKBANK.NS', price:1892, change:0.05, vol:4100000, mcap:3770000000000 },
    { ticker:'SBIN.NS', price:812, change:0.03, vol:14000000, mcap:7260000000000 },
    { ticker:'INDUSINDBK.NS', price:1042, change:-0.04, vol:3800000, mcap:810000000000 },
    { ticker:'IDFCFIRSTB.NS', price:67, change:-0.09, vol:22000000, mcap:480000000000 },
    { ticker:'FEDERALBNK.NS', price:198, change:-0.13, vol:6200000, mcap:480000000000 },
    { ticker:'BANDHANBNK.NS', price:172, change:-0.18, vol:5400000, mcap:277000000000 },
    { ticker:'PNB.NS', price:104, change:-0.24, vol:18000000, mcap:1150000000000 },
    { ticker:'BANKBARODA.NS', price:238, change:-0.29, vol:9600000, mcap:1230000000000 },
    { ticker:'CANBK.NS', price:107, change:-0.35, vol:12000000, mcap:970000000000 },
    { ticker:'SBILIFE.NS', price:1648, change:-0.4, vol:1100000, mcap:1650000000000 },
    { ticker:'HDFCLIFE.NS', price:692, change:-0.45, vol:2800000, mcap:1490000000000 },
    { ticker:'ICICIPRULI.NS', price:712, change:-0.51, vol:1900000, mcap:1020000000000 },
    { ticker:'MFSL.NS', price:1124, change:-0.56, vol:640000, mcap:340000000000 },
    { ticker:'MUTHOOTFIN.NS', price:2140, change:-0.6, vol:540000, mcap:860000000000 },
    { ticker:'BAJAJFINSV.NS', price:1892, change:-0.65, vol:1400000, mcap:3010000000000 },
    { ticker:'SUNDARMFIN.NS', price:4980, change:-0.7, vol:92000, mcap:292000000000 },
    { ticker:'LT.NS', price:3612, change:-0.75, vol:1600000, mcap:4970000000000 },
    { ticker:'ULTRACEMCO.NS', price:11820, change:-0.8, vol:270000, mcap:3410000000000 },
    { ticker:'SHREECEM.NS', price:27400, change:-0.84, vol:52000, mcap:987000000000 },
    { ticker:'AMBUJACEM.NS', price:584, change:-0.89, vol:3700000, mcap:2320000000000 },
    { ticker:'ACC.NS', price:2180, change:-0.94, vol:680000, mcap:410000000000 },
    { ticker:'GRASIM.NS', price:2842, change:-0.99, vol:1100000, mcap:1890000000000 },
    { ticker:'DLF.NS', price:812, change:-1.04, vol:4200000, mcap:2010000000000 },
    { ticker:'SUNPHARMA.NS', price:1782, change:-1.08, vol:2600000, mcap:4280000000000 },
    { ticker:'DRREDDY.NS', price:1282, change:-1.13, vol:980000, mcap:2140000000000 },
    { ticker:'CIPLA.NS', price:1524, change:-1.18, vol:1400000, mcap:1230000000000 },
    { ticker:'DIVISLAB.NS', price:6210, change:-1.22, vol:320000, mcap:1650000000000 },
    { ticker:'LUPIN.NS', price:2184, change:-1.27, vol:920000, mcap:993000000000 },
    { ticker:'TORNTPHARM.NS', price:3380, change:-1.32, vol:280000, mcap:572000000000 },
    { ticker:'AUROPHARMA.NS', price:1248, change:-1.36, vol:1600000, mcap:731000000000 },
    { ticker:'APOLLOHOSP.NS', price:7180, change:-1.41, vol:380000, mcap:1030000000000 },
    { ticker:'HINDUNILVR.NS', price:2284, change:-1.46, vol:1800000, mcap:5360000000000 },
    { ticker:'NESTLEIND.NS', price:2342, change:-1.5, vol:640000, mcap:2260000000000 },
    { ticker:'BRITANNIA.NS', price:5820, change:-1.55, vol:280000, mcap:1400000000000 },
    { ticker:'DABUR.NS', price:542, change:-1.6, vol:2900000, mcap:960000000000 },
    { ticker:'GODREJCP.NS', price:1082, change:-1.64, vol:1600000, mcap:1110000000000 },
    { ticker:'MARICO.NS', price:642, change:-1.69, vol:2200000, mcap:830000000000 },
    { ticker:'TATACONSUM.NS', price:1028, change:-1.74, vol:2400000, mcap:1010000000000 },
    { ticker:'TITAN.NS', price:3620, change:-1.78, vol:1200000, mcap:3220000000000 },
    { ticker:'ASIANPAINT.NS', price:2284, change:-1.83, vol:1600000, mcap:2190000000000 },
    { ticker:'BERGEPAINT.NS', price:524, change:-1.88, vol:1800000, mcap:510000000000 },
    { ticker:'PIDILITIND.NS', price:3240, change:-1.92, vol:640000, mcap:1640000000000 },
    { ticker:'ASTRAL.NS', price:2180, change:-1.97, vol:480000, mcap:580000000000 },
    { ticker:'PAGEIND.NS', price:48200, change:-2.02, vol:21000, mcap:537000000000 },
    { ticker:'DMART.NS', price:4820, change:-2.06, vol:820000, mcap:3140000000000 },
    { ticker:'JUBLFOOD.NS', price:582, change:-2.11, vol:2100000, mcap:388000000000 },
    { ticker:'IRCTC.NS', price:812, change:-2.16, vol:3200000, mcap:652000000000 },
    { ticker:'CONCOR.NS', price:842, change:-2.2, vol:1400000, mcap:513000000000 },
    { ticker:'ADANIENT.NS', price:2840, change:-2.25, vol:1800000, mcap:3240000000000 },
    { ticker:'BHARTIARTL.NS', price:1842, change:-2.3, vol:4800000, mcap:10800000000000 },
  ];

  allData = STOCKS.map(stock => {
    const d = demo.find(x => x.ticker === stock.ticker);
    const change = d ? d.change : (Math.random() * 6 - 2);
    const price = d ? d.price : 500 + Math.random() * 2000;
    const volume = d ? d.vol : Math.floor(Math.random() * 5000000 + 500000);
    const mcap = d ? d.mcap : volume * price * 50;
    return {
      ...stock,
      price,
      change1d: change,
      changeAbs: price * change / 100,
      volume,
      avgVolume: volume * (0.6 + Math.random() * 0.8),
      mcap,
      prevClose: price - (price * change / 100),
      change52w: change * 8 + (Math.random() * 20 - 10),
      ytdReturn: change * 3 / 100,
      change5d: change * 1.4,
      change1mo: change * 3.2,
    };
  });

  document.getElementById('nifty50val').innerHTML =
    `<span class="up">23,214 (+0.82%)</span>`;
  document.getElementById('nifty100val').innerHTML =
    `<span class="up">23,891 (+0.74%)</span>`;
  document.getElementById('sensexval').innerHTML =
    `<span class="up">76,520 (+0.79%)</span>`;

  document.getElementById('lastUpdated').textContent =
    'Demo Mode (deploy to Netlify for live data)';

  // FIXED: demo footer time also uses valid India time zone
  document.getElementById('footerTime').textContent =
    new Date().toLocaleTimeString('en-IN', { timeZone: 'Asia/Kolkata' });

  document.getElementById('errorBanner').style.display = 'block';
  document.getElementById('errorBanner').style.background = 'rgba(245,166,35,0.1)';
  document.getElementById('errorBanner').style.borderColor = 'rgba(245,166,35,0.3)';
  document.getElementById('errorBanner').style.color = '#ffcb6b';
  document.getElementById('errorBanner').textContent =
    'âš¡ Preview mode â€” showing demo data. Deploy to Netlify to get live NSE prices updated daily!';
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// INIT
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function init() {
  try {
    await loadData();
    renderAll();
  } catch(e) {
    console.warn('Live data unavailable, loading demo data:', e.message);
    loadDemoData();
    renderAll();
  } finally {
    const ls = document.getElementById('loadingScreen');
    setLoader(100, 'Done!');
    setTimeout(() => {
      ls.style.opacity = '0';
      setTimeout(() => ls.classList.add('hidden'), 400);
    }, 400);
  }
}

init();
</script>
